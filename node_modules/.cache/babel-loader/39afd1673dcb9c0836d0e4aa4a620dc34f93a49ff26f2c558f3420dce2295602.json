{"ast":null,"code":"import Node, { addNodeClass } from '../core/Node.js';\nimport { instancedBufferAttribute, instancedDynamicBufferAttribute } from './BufferAttributeNode.js';\nimport { normalLocal } from './NormalNode.js';\nimport { positionLocal } from './PositionNode.js';\nimport { nodeProxy, vec3, mat3, mat4 } from '../shadernode/ShaderNode.js';\nimport { DynamicDrawUsage, InstancedInterleavedBuffer } from 'three';\nclass InstanceNode extends Node {\n  constructor(instanceMesh) {\n    super('void');\n    this.instanceMesh = instanceMesh;\n    this.instanceMatrixNode = null;\n  }\n  setup(builder) {\n    let instanceMatrixNode = this.instanceMatrixNode;\n    if (instanceMatrixNode === null) {\n      const instanceMesh = this.instanceMesh;\n      const instanceAttribute = instanceMesh.instanceMatrix;\n      const buffer = new InstancedInterleavedBuffer(instanceAttribute.array, 16, 1);\n      const bufferFn = instanceAttribute.usage === DynamicDrawUsage ? instancedDynamicBufferAttribute : instancedBufferAttribute;\n      const instanceBuffers = [\n      // F.Signature -> bufferAttribute( array, type, stride, offset )\n      bufferFn(buffer, 'vec4', 16, 0), bufferFn(buffer, 'vec4', 16, 4), bufferFn(buffer, 'vec4', 16, 8), bufferFn(buffer, 'vec4', 16, 12)];\n      instanceMatrixNode = mat4(...instanceBuffers);\n      this.instanceMatrixNode = instanceMatrixNode;\n    }\n\n    // POSITION\n\n    const instancePosition = instanceMatrixNode.mul(positionLocal).xyz;\n\n    // NORMAL\n\n    const m = mat3(instanceMatrixNode[0].xyz, instanceMatrixNode[1].xyz, instanceMatrixNode[2].xyz);\n    const transformedNormal = normalLocal.div(vec3(m[0].dot(m[0]), m[1].dot(m[1]), m[2].dot(m[2])));\n    const instanceNormal = m.mul(transformedNormal).xyz;\n\n    // ASSIGNS\n\n    builder.stack.assign(positionLocal, instancePosition);\n    builder.stack.assign(normalLocal, instanceNormal);\n  }\n}\nexport default InstanceNode;\nexport const instance = nodeProxy(InstanceNode);\naddNodeClass('InstanceNode', InstanceNode);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}