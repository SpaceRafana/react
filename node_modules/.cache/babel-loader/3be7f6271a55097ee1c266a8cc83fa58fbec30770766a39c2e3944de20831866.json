{"ast":null,"code":"import TempNode from '../core/TempNode.js';\nimport { texture } from '../accessors/TextureNode.js';\nimport { addNodeClass } from '../core/Node.js';\nimport { uv } from '../accessors/UVNode.js';\nimport { normalView } from '../accessors/NormalNode.js';\nimport { positionView } from '../accessors/PositionNode.js';\nimport { faceDirection } from './FrontFacingNode.js';\nimport { tslFn, nodeProxy, vec2 } from '../shadernode/ShaderNode.js';\n\n// Bump Mapping Unparametrized Surfaces on the GPU by Morten S. Mikkelsen\n// https://mmikk.github.io/papers3d/mm_sfgrad_bump.pdf\n\n// Evaluate the derivative of the height w.r.t. screen-space using forward differencing (listing 2)\n\nconst dHdxy_fwd = tslFn(({\n  bumpTexture,\n  bumpScale\n}) => {\n  const uvNode = uv();\n  const Hll = texture(bumpTexture, uvNode).x;\n  return vec2(texture(bumpTexture, uvNode.add(uvNode.dFdx())).x.sub(Hll), texture(bumpTexture, uvNode.add(uvNode.dFdy())).x.sub(Hll)).mul(bumpScale);\n});\nconst perturbNormalArb = tslFn(inputs => {\n  const {\n    surf_pos,\n    surf_norm,\n    dHdxy\n  } = inputs;\n  const vSigmaX = surf_pos.dFdx();\n  const vSigmaY = surf_pos.dFdy();\n  const vN = surf_norm; // normalized\n\n  const R1 = vSigmaY.cross(vN);\n  const R2 = vN.cross(vSigmaX);\n  const fDet = vSigmaX.dot(R1).mul(faceDirection);\n  const vGrad = fDet.sign().mul(dHdxy.x.mul(R1).add(dHdxy.y.mul(R2)));\n  return fDet.abs().mul(surf_norm).sub(vGrad).normalize();\n});\nclass BumpMapNode extends TempNode {\n  constructor(texture, scaleNode = null) {\n    super('vec3');\n    this.texture = texture;\n    this.scaleNode = scaleNode;\n  }\n  setup() {\n    const bumpScale = this.scaleNode !== null ? this.scaleNode : 1;\n    const dHdxy = dHdxy_fwd({\n      bumpTexture: this.texture,\n      bumpScale\n    });\n    return perturbNormalArb({\n      surf_pos: positionView.negate(),\n      surf_norm: normalView,\n      dHdxy\n    });\n  }\n}\nexport default BumpMapNode;\nexport const bumpMap = nodeProxy(BumpMapNode);\naddNodeClass('BumpMapNode', BumpMapNode);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}